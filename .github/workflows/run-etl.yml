name: Run ETL (manual)
on: 
    workflow_dispatch:
        inputs:
            excel_path:
                description: "Excel path in repo (leave default to use current)"
                required: false 
                default: "etl/data/20241210_Excel-Tool_4-1_ErSi_Copy2.xlsm"

permissions:
    id-token: write
    contents: read

jobs:
    etl:
        runs-on: ubuntu-latest

        env: 
            RG: rg-cellcore-dev

        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                client-id: ${{ secrets.AZURE_CLIENT_ID }}
                tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            
            - name: Open temp firewall for runner IP
              shell: bash
              run: |
                SERVER_FQDN="${{ secrets.AZURE_SQL_SERVER_DEV }}"
                SERVER="${SERVER_FQDN%%.database.windows.net}"
                RUNNER_IP=$(curl -4 -s https://api.ipify.org)
                RULE="gh-elt-${RUNNER_IP//./-}"

                echo "SERVER=$SERVER" >> $GITHUB_ENV
                echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV
                echo "RULE=$RULE" >> $GITHUB_ENV

                echo "Opening firewall rule '$RULE' for $RUNNER_IP on server $SERVER in RG $RG"
                az sql server firewall-rule list -g "$RG" -s "$SERVER" -o table

            - uses: actions/setup-python@v5
              with: { python-version: '3.11' }

            - name: Install system ODBC + msodbcsql18
              run: | 
                set -euo pipefail
                sudo mkdir -p /usr/share/keyrings
                curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
                | sudo gpg --dearmor --yes -o /usr/share/keyrings/microsoft-prod.gpg
                echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/24.04/prod noble main" \
                | sudo tee /etc/apt/sources.list.d/microsoft-prod.list > /dev/null
                sudo apt-get update
                sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

            - name: Install Python deps
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Configure DB env for ETL
              run: |
                TOKEN=$(az account get-access-token --resource https://database.windows.net/ --query accessToken -o tsv)
                echo "AZURE_SQL_ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV
                echo "DB_SERVER=${{ secrets.AZURE_SQL_SERVER_DEV }}" >> $GITHUB_ENV
                echo "DB_NAME=${{ secrets.AZURE_SQL_DATABASE_DEV }}" >> $GITHUB_ENV
                echo "DB_DRIVER=ODBC Driver 18 for SQL Server" >> $GITHUB_ENV

            - name: Sanity-check critical imports
              env:
                PYTHONPATH: ${{ github.workspace }}
              run: |
                python -c "import pyodbc, pandas, openpyxl; print('imports OK')"

            - name: Run ETL
              env: 
                PYTHONPATH: ${{ github.workspace }}
              run: |
                python -X faulthandler etl/one_run_etl.py --smart --excel "${{ github.event.inputs.excel_path }}"

            - name: Close temp firewall hole
              if: always()
              shell: bash
              run: |
                if i[[ -n "${RULE:-}" && -n "${SERVER:-}" ]]; then
                    echo "Closing firewall runle '$RULE' on $SERVER in RG $RG"
                    az sql server firewall-rule delete -g "$RG" -s "$SERVER" -n "$RULE" || true
                else
                    echo "[INFO] Firewall env vars missing; nothing to clean up."
                fi
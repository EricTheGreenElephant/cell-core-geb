name: Run ETL (manual)
on: 
    workflow_dispatch:
        inputs:
            excel_path:
                description: "Excel path in repo (leave default to use current)"
                required: false 
                default: "etl/data/20241210_Excel-Tool_4-1_ErSi_Copy2.xlsm"

permissions:
    id-token: write
    contents: read

jobs:
    etl:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                client-id: ${{ secrets.AZURE_CLIENT_ID }}
                tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            
            - uses: actions/setup-python@v5
              with: { python-version: '3.11' }

            - name: Install system ODBC + msodbcsql18
              run: | 
                set -euo pipefail
                sudo mkdir -p /usr/share/keyrings
                curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
                | sudo gpg --dearmor --yes -o /usr/share/keyrings/microsoft-prod.gpg
                echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/24.04/prod noble main" \
                | sudo tee /etc/apt/sources.list.d/microsoft-prod.list > /dev/null
                sudo apt-get update
                sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

            - name: Install Python deps
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Configure DB env for ETL
              run: |
                TOKEN=$(az account get-access-token --resource https://database.windows.net/ --query accessToken -o tsv)
                echo "AZURE_SQL_ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV
                echo "DB_SERVER=${{ secrets.AZURE_SQL_SERVER_DEV }}" >> $GITHUB_ENV
                echo "DB_NAME=${{ secrets.AZURE_SQL_DATABASE_DEV }}" >> $GITHUB_ENV
                echo "DB_DRIVER=ODBC Driver 18 for SQL Server" >> $GITHUB_ENV

            - name: Run ETL
              run: |
                python etl/one_run_etl.py --smart --excel "${{ github.event.inputs.excel_path }}"
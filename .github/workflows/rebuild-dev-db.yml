name: Rebuild DEV database (drop + recreate + migrate)

on: 
    workflow_dispatch: {}

permissions:
    id-token: write
    contents: read

jobs:
    rebuild-dev-db:
        runs-on: ubuntu-latest

        env:
            RG: rg-cellcore-dev
            MIGRATIONS_DIR: db/migrations
            SEED_DIR: db/seed
            VIEWS_DIR: db/views
            POSTSEED_DIR: db/postseed
        
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                client-id: ${{ secrets.AZURE_CLIENT_ID }}
                tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Open temp firewall for runner IP
              shell: bash
              run: | 
                SERVER_FQDN="${{ secrets.AZURE_SQL_SERVER_DEV }}"
                SERVER="${SERVER_FQDN%%.database.windows.net}"
                RUNNER_IP=$(curl -4 -s https://api.ipify.org)
                RULE="gh-rebuild-${RUNNER_IP//./-}"

                echo "SERVER=$SERVER" >> $GITHUB_ENV
                echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV
                echo "RULE=$RULE" >> $GITHUB_ENV

                echo "Opening firewall rule '$RULE' for $RUNNER_IP on server $SERVER in RG $RG"
                az sql server firewall-rule create -g "$RG" -s "$SERVER" -n "$RULE" \
                  --start-ip-address "$RUNNER_IP" --end-ip-address "$RUNNER_IP"
                az sql server firewall-rule list -g "$RG" -s "$SERVER" -o table

            - name: Install sqlcmd (mssql-tools18)
              shell: bash
              run: |
                set -euo pipefail
                sudo mkdir -p /usr/share/keyrings
                curl -fsSL https://packages.microsoft.com/keys/microsoft.asc \
                    | sudo gpg --dearmor --yes -o /usr/share/keyrings/microsoft-prod.gpg
                echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/24.04/prod noble main" \
                    | sudo tee /etc/apt/sources.list.d/microsoft-prod.list > /dev/null
                sudo apt-get update
                sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
                echo "/opt/mssql-tools18/bin" >> "$GITHUB_PATH"

            - name: Set DB env
              shell: bash
              run: |
                echo "DB_SERVER=${{ secrets.AZURE_SQL_SERVER_DEV }}" >> $GITHUB_ENV
                echo "DB_NAME=${{ secrets.AZURE_SQL_DATABASE_DEV }}" >> $GITHUB_ENV

            - name: Acquire AAD token for Azure SQL
              shell: bash
              run: |
                set -euo pipefail
                TOKEN=$(az account get-access-token --resource https://database.windows.net/ --query accessToken -o tsv)
                echo "SQLCMDACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV
                TOKEN_FILE=/tmp/sqltoken
                printf '%s' "$TOKEN" | iconv -f ascii -t UTF-16LE > "$TOKEN_FILE"
                echo "TOKEN_FILE=$TOKEN_FILE" >> $GITHUB_ENV

            - name: Smoke test server connectivity
              shell: bash
              run: |
                sqlcmd -S "tcp:$DB_SERVER,1433" -d master -G -P "$TOKEN_FILE" -C -l 30 -b -Q "SELECT @@VERSION AS version; SELECT SUSER_SNAME() AS whoami;"

            - name: Stop Web App (prevents DB reconnection during rebuild)
              shell: bash
              run: |
                az webapp stop -g "$RG" -n "cellcore-streamlit-web" || true

            - name: Drop and recreate DEV database (Azure CLI)
              shell: bash
              run: |
                set -euo pipefail

                SERVER_FQDN="${DB_SERVER}"
                SERVER="${SERVER_FQDN%%.database.windows.net}"

                echo "Server short name: $SERVER"
                echo "Database name: $DB_NAME"

                echo "Deleting database (if it exists)..."
                if az sql db show -g "$RG" -s "$SERVER" -n "$DB_NAME" >/dev/null 2>&1; then
                  az sql db delete -g "$RG" -s "$SERVER" -n "$DB_NAME" --yes
                else
                  echo "DB not found in Azure control plane; skipping delete."
                fi

                echo "Waiting for DB to be fully gone..."
                for i in {1..60}; do
                  if az sql db show -g "$RG" -s "$SERVER" -n "$DB_NAME" >/dev/null 2>&1; then
                    echo "Still exists (attempt $i/60). Sleeping 5s..."
                    sleep 5
                  else
                    echo "DB is gone."
                    break
                  fi
                done

                if az sql db show -g "$RG" -s "$SERVER" -n "$DB_NAME" >/dev/null 2>&1; then
                  echo "ERROR: DB still exists after waiting. Aborting."
                  exit 1
                fi

                echo "Creating database..."
                # Pick the SKU you actually use. Examples:
                # --service-objective S0   (DTU model)
                # --compute-model Serverless --family Gen5 --capacity 2  (vCore example)
                az sql db create -g "$RG" -s "$SERVER" -n "$DB_NAME" --service-objective S0

                echo "Waiting for DB to become Online..."
                for i in {1..60}; do
                  state=$(az sql db show -g "$RG" -s "$SERVER" -n "$DB_NAME" --query status -o tsv 2>/dev/null || true)
                  echo "Status: $state"
                  if [[ "$state" == "Online" ]]; then
                    echo "DB is Online."
                    break
                  fi
                  sleep 5
                done


            - name: Define run_folder function
              shell: bash
              run: |
                cat <<'EOF' > /tmp/run_folder.sh
                #!/usr/bin/env bash
                set -euo pipefail

                FOLDER="$1"
                if [[ ! -d "$FOLDER" ]]; then
                    echo "[INFO] $FOLDER does not exist; skipping."
                    exit 0
                fi

                shopt -s nullglob
                files=( "$FOLDER"/*.sql )
                if (( ${#files[@]} == 0)); then
                    echo "[INFO] No .sql files in $FOLDER; skipping."
                    exit 0
                fi

                IFS=$'\n' files=($(printf '%s\n' "${files[@]}" | sort))
                for f in "${files[@]}"; do
                    base="$(basename "$f")"

                    if [[ "$base" == "31_seed_group_area_rights.sql" ]]; then
                        echo "[INFO] Skipping special param script $base (handled in separate step)."
                        continue
                    fi

                    echo "==> Applying: $f"
                    sqlcmd \
                        -S "tcp:$DB_SERVER,1433" \
                        -d "$DB_NAME" \
                        -G \
                        -P "$TOKEN_FILE" \
                        -C \
                        -l 60 \
                        -b \
                        -I \
                        -i "$f"
                done
                EOF
                chmod +x /tmp/run_folder.sh

            
            - name: Apply migrations
              shell: bash
              run: /tmp/run_folder.sh "$MIGRATIONS_DIR"

            - name: Apply seeds (DEV)
              shell: bash
              run: /tmp/run_folder.sh "$SEED_DIR"

            - name: Load group OIDs from secrets
              shell: bash
              run: |
                echo "PROD_READ_OID=${{ secrets.PROD_READ_OID }}"       >> $GITHUB_ENV
                echo "PROD_WRITE_OID=${{ secrets.PROD_WRITE_OID }}"     >> $GITHUB_ENV
                echo "LOG_READ_OID=${{ secrets.LOG_READ_OID }}"         >> $GITHUB_ENV
                echo "LOG_WRITE_OID=${{ secrets.LOG_WRITE_OID }}"       >> $GITHUB_ENV
                echo "QM_READ_OID=${{ secrets.QM_READ_OID }}"           >> $GITHUB_ENV
                echo "QM_WRITE_OID=${{ secrets.QM_WRITE_OID }}"         >> $GITHUB_ENV
                echo "SALES_READ_OID=${{ secrets.SALES_READ_OID }}"     >> $GITHUB_ENV
                echo "SALES_WRITE_OID=${{ secrets.SALES_WRITE_OID }}"   >> $GITHUB_ENV
                echo "GLOBAL_ADMIN_OID=${{ secrets.GLOBAL_ADMIN_OID }}" >> $GITHUB_ENV
            
            - name: Seed group-area rights (parameterized)
              shell: bash
              run: |
                sqlcmd -S "tcp:$DB_SERVER,1433" -d "$DB_NAME" -G -P "$TOKEN_FILE" -C -b -I \
                  -v PROD_READ_OID="${PROD_READ_OID:-}" \
                  -v PROD_WRITE_OID="${PROD_WRITE_OID:-}" \
                  -v LOG_READ_OID="${LOG_READ_OID:-}" \
                  -v LOG_WRITE_OID="${LOG_WRITE_OID:-}" \
                  -v QM_READ_OID="${QM_READ_OID:-}" \
                  -v QM_WRITE_OID="${QM_WRITE_OID:-}" \
                  -v SALES_READ_OID="${SALES_READ_OID:-}" \
                  -v SALES_WRITE_OID="${SALES_WRITE_OID:-}" \
                  -v GLOBAL_ADMIN_OID="${GLOBAL_ADMIN_OID:-}" \
                  -i db/seed/31_seed_group_area_rights.sql

            - name: Apply views
              shell: bash
              run: /tmp/run_folder.sh "$VIEWS_DIR"

            - name: Apply postseed
              shell: bash
              run: /tmp/run_folder.sh "$POSTSEED_DIR"

            - name: Start Web App
              if: always()
              shell: bash
              run: |
                az webapp start -g "$RG" -n "cellcore-streamlit-web" || true

            - name: Close temp firewall hole
              if: always()
              shell: bash
              run: |
                if [[ -n "${RULE:-}" && -n "${SERVER:-}" ]]; then
                    echo "Closing firewall rule '$RULE' on $SERVER in RG $RG"
                    az sql server firewall-rule delete -g "$RG" -s "$SERVER" -n "$RULE" || true
                else
                    echo "[INFO] Firewall env vars missing; nothing to clean up."
                fi